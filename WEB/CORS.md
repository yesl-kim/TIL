# CORS

## 정의

CORS란, 교차 출처간에 리소스를 공유하는데 권한을 부여하도록 브라우저에 알려주는 체제이다.

## CORS 접근제어 시나리오

기본적으로 브라우저는 보안상의 이유로 교차 출처간의 HTTP 요청을 제한한다. (= 동일 출처 정책, SOP)

즉, 웹 애플리케이션은 자신과 동일한 출처의 리소스만 사용할 수 있으며, **다른 출처의 리소스를 사용하려면 그 출처에서 올바른 CORS 헤더를 포함한 응답을 반환해야 한다.**

### 단순요청일 경우

**단순요청** (아래 조건을 모두 충족한 요청)

- GET, HEAD, POST 메소드를 사용한 요청
- `Accept`, `Accept-lauguage`, `Content-language`, `Content-type` 값만 수동으로 설정할 수 있음
- Content-type 값은 이중 하나만 가질 수 있음
  - `application/x-www-form-urlencoded`
  - `multipart/form-data`
  - `text/plain`
- 요청에 `ReadableStream` 객체가 사용되지 않음

단순요청에 대한 응답으로 서버에서는 Access-Control-Allow-Origin 헤더를 다시 전송한다.

가장 간단한 접근 제어 프로토콜은 Origin 헤더와 Access-Control-Allow-Origin 을 사용하는 것이다. 브라우저에서 요청의 Origin 헤더와 응답의 Access-Control-Allow-Origin 을 확인하여 리소스 접근을 제한한다.

### 단순요청이 아닐 경우(-> 프리플라이트 요청)

**프리플라이트 요청**

- 단순 요청을 제외한, 리소스에 부수 효과를 일으킬 수 있는 요청
- 단순요청이 아닌 요청

요청이 단순요청이 아닌 경우, OPTIONS 메소드를 통해 실제 요청이 전송하기에 안전한지 확인한다.(= preflight request) 안전한 요청으로 확인되면 실제요청을 보낸다.

프리플라이트 요청에서 헤더에 access-control-request-method로 실제 요청의 메소드가 무엇인지, access-control-request-headers로 실제 요청의 헤더가 무엇인지 서버에게 알린다.

응답 헤더에는 접근 가능한 출처에서 사용가능한 메소드와 헤더가 무엇인지 access-control-allow-method, access-control-allow-headers를 통해 나타낸다. → 실제 요청을 수락할지 결정한다.
access-control-allow-max-age는 최대 캐싱시간으로 다른 프리플라이트 요청을 보내지 않고 프리플라이트 요청에 응답할 수 있는 시간을 나타낸다.

_preflight request는 브라우저에서 자동적으로 발생된다. 때문에 프론트엔드 개발자가 직접 작성할 필요는 없다._

### 프리플라이트 리다이렉트

모든 브라우저에서 프리플라이트 리다이렉트를 지원하지는 않기 때문에 _일부 브라우저에서 리다이렉트 발생시 오류 메세지를 띠울 수 있다._ 이 때는 다음 방법을 통해 해결할 수 있다.

- 프리플라이트 리다이렉트를 방지하기 위해 서버측 동작을 변경한다.
- 프리플라이트가 발생하지 않는 단순요청으로 요청을 변경한다.

## Q&A

- 프리플라이트 리다이렉트를 지원하지 않는 브라우저에서 해결방법이 이해가 가지 않음
- 프리플라이트 요청은 브라우저에서 요청이 단순요청인지 확인이 필요한 요청인지 확인해서 브라우저 자체적으로 보내는 요청인건가? yes
